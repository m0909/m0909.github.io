<!DOCTYPE html>
<html lang="en"> 
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

        <style>
            span.comment-author {
                font-size: 12px;
                color: grey;
            }
            span.comment-time {
                font-size: 12px;
                color: grey;
                margin-left: 10px;
            }
            span.comment-core {
                font-size: 14px;
                color: black;
                display: block; /* force this to go out */
                margin-top: 6px;
            }
            div.comment {
                /*border-top: solid 2px black;*/
                margin-bottom: 30px;
            }
            div.response {
                margin-left: 20px;
                /*border-top: solid 1px gray; */
                margin-top: 6px;
            }
        </style>

        <script src="https://apis.google.com/js/api.js"></script>
        <script>
        /**
         * Sample JavaScript code for youtube.commentThreads.list
         * See instructions for running APIs Explorer code samples locally:
         * https://developers.google.com/explorer-help/guides/code_samples#javascript
         */

        function updateStatus(text, isDone=false) {
            var node = document.getElementById('statusBar');
            var html = "<p>Status: " + text + "</p>";
            if ( isDone ) {
                html = html + "<button onclick=\"document.location.reload(true)\">Select another video</button>";
            }
            node.innerHTML = html;
        }

        function loadClient() {
            gapi.client.setApiKey("AIzaSyCLt8kDGTOUvYaWuaT61gQCtFxuFO4h3_8");
            updateStatus("Loading YouTube client API");
            return gapi.client.load("https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest")
                .then(function() { 
                    console.log("GAPI client loaded for API"); 
                    updateStatus("Loaded YouTube client API");
                    var videoId = document.getElementById("videoId").value;
                    console.log("Video ID = " + videoId)
                    loadPage(videoId);
                    },
                    function(err) { console.error("Error loading GAPI client for API", err); });
        }

        function printSnippet(snippet, topLevelDiv = null) {
            var outputSection = document.getElementById('outputSection');
            var div;
            var node;
            var content;

            div = document.createElement("div");
            if ( topLevelDiv == null ) {
                div.setAttribute("class","comment");
            }
            else {
                div.setAttribute("class","response");
            }
            
            node = document.createElement("span");
            node.setAttribute("class", "comment-author")
            content = document.createTextNode(snippet.authorDisplayName);
            node.appendChild(content);
            div.appendChild(node)

            node = document.createElement("span");
            node.setAttribute("class", "comment-time")
            content = document.createTextNode(snippet.publishedAt);
            node.appendChild(content);
            div.appendChild(node)
            
            node = document.createElement("span");
            node.setAttribute("class", "comment-core")
            content = document.createTextNode(snippet.textDisplay);
            node.appendChild(content);
            div.appendChild(node)
            
            
            if ( topLevelDiv == null ) {
                outputSection.appendChild(div);
            }
            else {
                topLevelDiv.appendChild(div);
            }

            return div;
        }

        function extractInfo(result) {
            console.log(result);
            result.items.forEach(element => {
                var topLevel = element.snippet.topLevelComment;
                var topLevelDiv = printSnippet(topLevel.snippet);
                
                // show replies if present
                if ( element["replies"] ) {
                    element.replies.comments.forEach(response => {
                        printSnippet(response.snippet, topLevelDiv);
                    });
             
                }
            });
        }

        function loadPage(videoId, pageToken="") {
            if ( pageToken == "" ) {
                updateStatus("Loading comments");
            }
            else {
                updateStatus("Loading more comments (seq " + pageToken + ")");
            }
            
            return gapi.client.youtube.commentThreads.list({
            "part": [
                "replies,snippet"
            ],
            "maxResults": 100,
            "pageToken": pageToken,
            "videoId": videoId
            })
                .then(
                    function(response) {
                        // Handle the results here (response.result has the parsed body).
                        updateStatus("Processing comments");
                        var result = response.result;
                        console.log("Response", result);
                        extractInfo(result);

                        // iterative call to get subsequent comments
                        if ( result["nextPageToken"] ) {
                            loadPage(videoId, result.nextPageToken);
                        }
                        else {
                            updateStatus("Processed all comments", true);
                        }
                    },
                    function(err) { 
                        console.error("Execute error", err); 
                    });
        }
        
        function execute() {
            // when loadClient is done, it calls loadPage    
            loadClient();
        }

        gapi.load("client");
        </script>
    </head>

    <body>
        <h1>YouTube Video Comment Extractor</h1>
        <table>
            <tbody>
                <tr><td>YouTube video ID:</td><td><input type="text" id="videoId" value="" autofocus /></td></tr>
            </tbody>
        </table>
        <div id="statusBar">
            <button id="execute" onclick="execute()">Start</button>
        </div>        
        <div id="outputSection">
        </div>
    </body>
</html> 